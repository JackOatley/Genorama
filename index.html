<body>
<canvas id=a></canvas>
<script>
a.width = 960;
a.height = 480;
c = a.getContext("2d");

//
let WATER = "#44a4ff",
	GRASS = "#53a342",
	TREE = "#2f660066",
	STONE = "#666",
	HILL = "#8c6038",
	SAND = "#FF0",
	SEA = "#0671d6",
	DRYLANDS = "#a6ba57",
	SNOW = "#FFF"

// Set up permutation list.
var permutation = [];
for (var n=0; n<512; n++) {
	permutation[n] = ~~(Math.random() * 256);
}

/**
 * @param {number} x
 * @param {number} y
 * @param {number} g Gain.
 * @param {number} f Frequency.
 * @param {number} o Octaves.
 * t is Total. a is Amplitude. l is Lacunarity.
 */
function getHeight(x, y, g, f, o) {
	var t = 0, a = g, l = 2.0;
	for (i=0; i<o; i++) {
		t += noise(x*f, y*f) * a;
		f *= l;
		a *= g;
	}
	return t;
}

/**
 *
 */
function gradient(h, u, v) {
	h = h & 7;
	if ( h >= 4 ) {
		var a = u;
		u = v;
		v = a;
	}
	if ( h & 1 ) {
		if ( h & 2 )
			return -u + -2.0 * v;
		else
			return -u + 2.0 * v;
	} else {
		if ( h & 2 )
			return  u + -2.0 * v;
		else
			return  u + 2.0 * v;
	}
}

/**
 *
 */
function noise(x, y) {

	var s = (x+y)*0.366025403;
	var i = Math.floor(x + s);
	var j = Math.floor(y + s);

	var t = (i+j)*0.211324865;
	var x0 = x-(i-t);
	var y0 = y-(j-t);

	var i1 = (x0 > y0);

	var x1 = x0 - i1  + 0.211324865;
	var y1 = y0 - !i1 + 0.211324865;
	var x2 = x0 - 0.57735027;
	var y2 = y0 - 0.57735027;

	var ii = i & 255;
	var jj = j & 255;

	var plist = permutation;

	var total = 0;
	var t0 = 0.5 - x0*x0-y0*y0;
	if (t0 >= 0) {
		total += Math.pow(t0, 4) * gradient(plist[ii+plist[jj]], x0, y0);
	}

	var t1 = 0.5 - x1*x1-y1*y1;
	if (t1 >= 0) {
		total += Math.pow(t1, 4) * gradient(plist[ii+i1+plist[jj+!i1]], x1, y1);
	}

	var t2 = 0.5 - x2*x2-y2*y2;
	if (t2 >= 0) {
		total += Math.pow(t2, 4) * gradient(plist[ii+1+plist[jj+1]], x2, y2);
	}

	return 40 * total;

}

/**
 * @param {number} x
 * @param {number} y
 */
function generateCell(x, y) {

	x /= 4
	y /= 4

	// base
	var type = GRASS;

	//
	var river = Math.pow(Math.abs(getHeight(x, y, 1, 0.0025, 4)), 2.5);
	var tributary = Math.pow(Math.abs(getHeight(x, y, 1, 0.04, 1)), 2);
	var moisture = river * 0.8 + getHeight(x, y, 1, 0.16, 1) * 0.2;

	if (moisture > 1.5) {
		type = DRYLANDS;
	}

	// forests
	var forest = getHeight(x, y, 1, 0.005, 1);
	if (forest > 0.6 || (forest > 0.2 && moisture < 0.000001)) type = TREE;

	// mountain
	var height = 1 + getHeight(x, y, 1, 0.04, 1) * 0.4;
	height += getHeight(x, y, 1, 0.02, 1) * 0.6;
	height += getHeight(x, y, 1, 0.16, 1) * 0.6;
	height *= river;
	//if (height > 1.2) type = STONE;
	//if (height > 5) type = SNOW;

	// hills
	height += 0.5 + getHeight(y, x, 1, 0.16, 1) * 0.5;
	if (height > 1.1 && height <= 1.2) type = HILL;
	height += 0.8;

	// rivers
	if (river < 0.005) type = WATER;
	tributary += river * 0.2;
	if (tributary < 0.025) type = WATER;

	height -= (1 + getHeight(x, y, 1, 0.08, 1)) * 0.2;
	//if (height <= 0.12) type = SAND;
	//if (height <= 0.1) type = WATER;

	height -= Math.pow(200, getHeight(x, y, 1, 0.0008, 1));
	if (height <= -1.2) type = SAND;
	if (height <= -1.5) type = WATER;
	if (height <= -4) type = SEA;
	if (height > 2) type = STONE;
	if (height > 8) type = SNOW;

	return {
		type: type,
		height: (type === TREE) ? 9
			  : (type === WATER || type === SEA || type === SAND) ? height/4
			  : height*2
	}

}

for (var x=0; x<960; x++)
for (var y=0; y<480; y++) {
	var cell = generateCell(x, y*4);
	var cell2 = generateCell(x+5, y*4+5);
	c.fillStyle = cell.type;
	c.fillRect(x, y-cell.height, 1, cell.height*2);
	if (cell.height < cell2.height) {
		c.fillStyle = "#0002";
		c.fillRect(x, y-cell.height, 1, cell.height*2);
	}
}

let mx = 960;
let mspeed = 2;
function step() {
	mx+=mspeed;
	c.drawImage(a, -mspeed, 0);
	for (var x=0; x<mspeed; x++)
	for (var y=0; y<480; y++) {
		var cell = generateCell(mx+x, y*4);
		var cell2 = generateCell(mx+x+5, y*4+5);
		c.fillStyle = cell.type;
		c.fillRect(960-mspeed+x, y-cell.height, 1, cell.height*2);
		if (cell.height < cell2.height) {
			c.fillStyle = "#0002";
			c.fillRect(960-mspeed+x, y-cell.height, 1, cell.height*2);
		}
	}
	window.requestAnimationFrame(step);
}

window.requestAnimationFrame(step);

</script>
</body>
